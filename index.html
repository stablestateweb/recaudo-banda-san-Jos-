<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Banda San Jos√© v.1.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.5)), url('./fondo.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        .glass-effect {
            background-color: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="min-h-screen pb-24 text-gray-800">

    <header class="bg-green-800 text-white p-5 text-center shadow-xl border-b-4 border-yellow-500">
        <h1 class="text-xl font-bold uppercase tracking-tight">Banda Sinf√≥nica San Jos√©</h1>
        <div id="status-online" class="text-[10px] font-bold mt-1 text-green-300 uppercase tracking-widest">
            ‚óè Sistema en L√≠nea
        </div>
    </header>

    <nav class="flex bg-white sticky top-0 z-30 shadow-md">
        <button onclick="mostrarSeccion('registro')" id="btn-reg" class="flex-1 p-4 font-bold text-green-700 border-b-4 border-green-700 transition-all">
            <i class="fas fa-edit mr-2"></i>REGISTRO
        </button>
        <button onclick="mostrarSeccion('directorio')" id="btn-dir" class="flex-1 p-4 font-bold text-gray-400 border-b-4 border-transparent transition-all">
            <i class="fas fa-list-ul mr-2"></i>DIRECTORIO
        </button>
    </nav>

    <main id="sec-registro" class="p-4 max-w-md mx-auto">
        <div class="glass-effect p-6 rounded-3xl shadow-2xl border-t-8 border-green-600 mt-2">
            <h2 id="form-title" class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-file-signature text-green-600 mr-2"></i> Nuevo Aporte
            </h2>
            <form id="mainForm" class="space-y-3">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Ubicaci√≥n</label>
                    <select id="vereda" required class="w-full border-2 p-3 rounded-xl bg-white outline-none focus:border-green-500">
                        <option value="" disabled selected>Seleccione Vereda...</option>
                        <option>Altomira</option><option>Arrayanes</option><option>Buenavista</option>
                        <option>El Bosque</option><option>El Contento</option><option>El Pac√≠fico</option>
                        <option>El Vaticano</option><option>Guaimaral</option><option>La Ci√©naga</option>
                        <option>La Estrella</option><option>La Morelia</option><option>La Paz</option>
                        <option>La Primavera</option><option>Los Ca√≠mos</option><option>Morro Azul</option>
                        <option>Pueblo Rico</option><option>Tamboral</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Nombre del Predio</label>
                    <input type="text" id="finca" placeholder="Nombre de la Finca" required class="w-full border-2 p-3 rounded-xl outline-none focus:border-green-500">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Encargado</label>
                    <input type="text" id="responsable" placeholder="Propietario / Administrador" required class="w-full border-2 p-3 rounded-xl outline-none focus:border-green-500">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Contacto</label>
                    <input type="tel" id="telefono" placeholder="N√∫mero de Tel√©fono" required class="w-full border-2 p-3 rounded-xl outline-none focus:border-green-500">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">¬øAport√≥?</label>
                        <select id="aporto" class="w-full border-2 p-3 rounded-xl bg-white outline-none focus:border-green-500">
                            <option>S√≠</option>
                            <option>No</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Racimos</label>
                        <input type="number" id="cantidad" value="0" min="0" class="w-full border-2 p-3 rounded-xl font-bold text-green-700 outline-none focus:border-green-500">
                    </div>
                </div>

                <button type="submit" id="btn-save" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-lg mt-4 active:scale-95 transition-all">
                    GUARDAR DATOS üçå
                </button>
                <button type="button" id="btn-cancel" onclick="resetForm()" class="hidden w-full bg-gray-500 text-white font-bold py-2 rounded-xl mt-2 text-sm">
                    CANCELAR EDICI√ìN
                </button>
            </form>
            <div id="offline-msg" class="hidden mt-4 p-3 bg-amber-100 text-amber-800 text-[11px] rounded-lg font-bold text-center border border-amber-200">
                ‚ö†Ô∏è SIN CONEXI√ìN: Datos protegidos en el celular. Se sincronizar√°n al detectar internet.
            </div>
        </div>
    </main>

    <main id="sec-directorio" class="p-4 max-w-md mx-auto hidden">
        <div class="flex justify-between items-center mb-4 glass-effect p-3 rounded-xl shadow border-b-2 border-green-500">
            <h2 class="font-bold text-gray-700">Registros en la Nube</h2>
            <button onclick="cargarDatos()" class="bg-green-600 text-white p-2 px-3 rounded-lg text-sm active:rotate-180 transition-all duration-500">
                <i class="fas fa-sync"></i>
            </button>
        </div>
        <div id="lista" class="space-y-4 pb-10"></div>
    </main>

    <footer class="text-center p-3 text-gray-500 text-[10px] uppercase font-bold tracking-widest fixed bottom-0 w-full bg-white/90 backdrop-blur-sm border-t border-gray-100">
        Banda Sinf√≥nica San Jos√© | Caldas
    </footer>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbow393wQhfOrt85djreYPjxG21AfUERZnOVNIfVJZkjWd8s74zGflsw1uQhxzfe-WGQw/exec';

        // GESTI√ìN DE ESTADO ONLINE/OFFLINE
        window.addEventListener('online', () => {
            document.getElementById('status-online').innerText = "‚óè Sistema en L√≠nea";
            document.getElementById('status-online').className = "text-[10px] font-bold mt-1 text-green-300 uppercase tracking-widest";
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            document.getElementById('status-online').innerText = "‚óè Modo Offline (Seguro)";
            document.getElementById('status-online').className = "text-[10px] font-bold mt-1 text-amber-400 uppercase tracking-widest";
        });

        function mostrarSeccion(s) {
            document.getElementById('sec-registro').classList.toggle('hidden', s !== 'registro');
            document.getElementById('sec-directorio').classList.toggle('hidden', s !== 'directorio');
            document.getElementById('btn-reg').className = s === 'registro' ? "flex-1 p-4 font-bold text-green-700 border-b-4 border-green-700" : "flex-1 p-4 font-bold text-gray-400 border-b-4 border-transparent";
            document.getElementById('btn-dir').className = s === 'directorio' ? "flex-1 p-4 font-bold text-green-700 border-b-4 border-green-700" : "flex-1 p-4 font-bold text-gray-400 border-b-4 border-transparent";
            if(s === 'directorio') cargarDatos();
        }

        const form = document.getElementById('mainForm');
        form.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                action: id ? 'editRegistro' : 'addRegistro',
                id: id,
                finca: document.getElementById('finca').value,
                responsable: document.getElementById('responsable').value,
                telefono: document.getElementById('telefono').value,
                vereda: document.getElementById('vereda').value, 
                aporto: document.getElementById('aporto').value,
                cantidad: document.getElementById('cantidad').value
            };

            if (navigator.onLine) {
                enviarAGoogle(data);
            } else {
                saveLocally(data);
                document.getElementById('offline-msg').classList.remove('hidden');
                setTimeout(() => { resetForm(); alert("Guardado localmente. Se enviar√° al detectar internet."); }, 500);
            }
        });

        function enviarAGoogle(data) {
            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.innerText = "Sincronizando...";

            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
            .then(() => {
                resetForm();
                btn.disabled = false;
                btn.innerText = "GUARDAR DATOS üçå";
                if(data.action === 'editRegistro') {
                    alert("Cambios guardados con √©xito.");
                    mostrarSeccion('directorio');
                } else {
                    alert("Registro guardado en la nube.");
                }
            })
            .catch(() => {
                saveLocally(data);
                alert("Error de conexi√≥n. Guardado en memoria local.");
                resetForm();
            });
        }

        function saveLocally(data) {
            let pending = JSON.parse(localStorage.getItem('banda_sync') || '[]');
            pending.push(data);
            localStorage.setItem('banda_sync', JSON.stringify(pending));
        }

        function syncOfflineData() {
            let pending = JSON.parse(localStorage.getItem('banda_sync') || '[]');
            if (pending.length > 0) {
                pending.forEach(d => enviarAGoogle(d));
                localStorage.removeItem('banda_sync');
            }
        }

        function cargarDatos() {
            const lista = document.getElementById('lista');
            lista.innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-white text-4xl"></i></div>';
            
            fetch(scriptURL + '?getRegistros=true')
            .then(res => res.json())
            .then(datos => {
                lista.innerHTML = "";
                if(datos.length === 0) {
                    lista.innerHTML = '<p class="text-center text-white font-bold bg-black/30 p-10 rounded-2xl">No hay registros.</p>';
                    return;
                }
                datos.reverse().forEach(item => {
                    const card = document.createElement('div');
                    card.className = "glass-effect p-4 rounded-2xl shadow-lg border-l-8 " + (item.aporto === 'S√≠' ? 'border-green-600' : 'border-amber-500');
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900 leading-tight">${item.finca}</h3>
                                <p class="text-[10px] text-green-700 font-bold uppercase mb-2"><i class="fas fa-map-marker-alt"></i> ${item.vereda}</p>
                                <div class="space-y-1">
                                    <p class="text-xs text-gray-600"><i class="fas fa-user text-gray-400 mr-1"></i> ${item.responsable}</p>
                                    <p class="text-xs text-blue-600 font-bold"><i class="fas fa-phone text-blue-300 mr-1"></i> ${item.telefono}</p>
                                </div>
                            </div>
                            <div class="text-center bg-green-100 p-2 rounded-xl min-w-[65px] border border-green-200">
                                <span class="text-2xl font-black text-green-800">${item.cantidad}</span>
                                <p class="text-[8px] font-bold text-green-700 uppercase">Racimos</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4 pt-3 border-t border-gray-100">
                            <button onclick='iniciarEdicion(${JSON.stringify(item)})' class="flex-1 bg-blue-50 text-blue-700 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider">
                                <i class="fas fa-edit mr-1"></i> Editar
                            </button>
                            <button onclick="eliminarRegistro(${item.id})" class="flex-1 bg-red-50 text-red-600 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider">
                                <i class="fas fa-trash mr-1"></i> Eliminar
                            </button>
                        </div>`;
                    lista.appendChild(card);
                });
            })
            .catch(() => {
                lista.innerHTML = '<p class="text-center text-white p-10">Revisa tu conexi√≥n a internet.</p>';
            });
        }

        function iniciarEdicion(item) {
            mostrarSeccion('registro');
            document.getElementById('form-title').innerHTML = '<i class="fas fa-edit text-blue-600 mr-2"></i> Editando Registro';
            document.getElementById('edit-id').value = item.id;
            document.getElementById('finca').value = item.finca;
            document.getElementById('responsable').value = item.responsable;
            document.getElementById('telefono').value = item.telefono;
            document.getElementById('vereda').value = item.vereda;
            document.getElementById('aporto').value = item.aporto;
            document.getElementById('cantidad').value = item.cantidad;
            document.getElementById('btn-save').innerText = "GUARDAR CAMBIOS";
            document.getElementById('btn-save').classList.replace('bg-green-600', 'bg-blue-600');
            document.getElementById('btn-cancel').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function resetForm() {
            form.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('form-title').innerHTML = '<i class="fas fa-file-signature text-green-600 mr-2"></i> Nuevo Aporte';
            document.getElementById('btn-save').innerText = "GUARDAR DATOS üçå";
            document.getElementById('btn-save').classList.replace('bg-blue-600', 'bg-green-600');
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('offline-msg').classList.add('hidden');
        }

        function eliminarRegistro(id) {
            if(!confirm("¬øDeseas eliminar permanentemente esta finca del listado?")) return;
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'deleteRegistro', id: id}) })
            .then(() => { alert("Registro eliminado."); cargarDatos(); });
        }
    </script>
</body>
</html>
