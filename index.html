<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Banda San Jos√© v.1.10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.5)), url('./fondo.png');
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .glass-effect { background-color: rgba(255, 255, 255, 0.96); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen pb-24 text-gray-800">

    <header class="bg-green-800 text-white p-5 text-center shadow-xl border-b-4 border-yellow-500">
        <h1 class="text-xl font-bold uppercase">Banda Sinf√≥nica San Jos√©</h1>
        <div id="status-online" class="text-[10px] font-bold mt-1 text-green-300 uppercase">‚óè Sistema Conectado</div>
    </header>

    <nav class="flex bg-white sticky top-0 z-30 shadow-md">
        <button onclick="mostrarSeccion('registro')" id="btn-reg" class="flex-1 p-4 font-bold text-green-700 border-b-4 border-green-700">REGISTRO</button>
        <button onclick="mostrarSeccion('directorio')" id="btn-dir" class="flex-1 p-4 font-bold text-gray-400 border-b-4 border-transparent">DIRECTORIO</button>
    </nav>

    <main id="sec-registro" class="p-4 max-w-md mx-auto">
        <div class="glass-effect p-6 rounded-3xl shadow-2xl border-t-8 border-green-600 mt-2">
            <h2 id="form-title" class="text-lg font-bold mb-4 italic">Nuevo Aporte de Pl√°tano</h2>
            <form id="mainForm" class="space-y-3">
                <input type="hidden" id="edit-id">
                <select id="vereda" required class="w-full border-2 p-3 rounded-xl bg-white">
                    <option value="" disabled selected>Seleccione Vereda...</option>
                    <option>Altomira</option><option>Arrayanes</option><option>Buenavista</option>
                    <option>El Bosque</option><option>El Contento</option><option>El Pac√≠fico</option>
                    <option>El Vaticano</option><option>Guaimaral</option><option>La Ci√©naga</option>
                    <option>La Estrella</option><option>La Morelia</option><option>La Paz</option>
                    <option>La Primavera</option><option>Los Ca√≠mos</option><option>Morro Azul</option>
                    <option>Pueblo Rico</option><option>Tamboral</option>
                </select>
                <input type="text" id="finca" placeholder="Nombre de la Finca" required class="w-full border-2 p-3 rounded-xl">
                <input type="text" id="responsable" placeholder="Propietario / Administrador" required class="w-full border-2 p-3 rounded-xl">
                <input type="tel" id="telefono" placeholder="Tel√©fono de contacto" required class="w-full border-2 p-3 rounded-xl">
                <div class="grid grid-cols-2 gap-3">
                    <select id="aporto" class="border-2 p-3 rounded-xl bg-white"><option>S√≠</option><option>No</option></select>
                    <input type="number" id="cantidad" value="0" min="0" class="border-2 p-3 rounded-xl font-bold text-green-700">
                </div>
                <button type="submit" id="btn-save" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-lg mt-4 active:scale-95">GUARDAR REGISTRO üçå</button>
                <button type="button" id="btn-cancel" onclick="resetForm()" class="hidden w-full bg-gray-500 text-white font-bold py-2 rounded-xl mt-2">CANCELAR EDICI√ìN</button>
            </form>
        </div>
    </main>

    <main id="sec-directorio" class="p-4 max-w-md mx-auto hidden">
        <div class="flex justify-between items-center mb-4 glass-effect p-3 rounded-xl shadow border-b-2 border-green-500">
            <h2 class="font-bold text-gray-700">Recolecci√≥n en Campo</h2>
            <button onclick="cargarDatos()" class="bg-green-600 text-white p-2 px-3 rounded-lg text-sm"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="lista" class="space-y-4 pb-10"></div>
    </main>

    <footer class="text-center p-3 text-gray-500 text-[10px] uppercase font-bold fixed bottom-0 w-full bg-white/90 backdrop-blur-sm border-t border-gray-100">
        Banda Sinf√≥nica San Jos√© | v.1.10
    </footer>

    <script>
        // REEMPLAZA ESTA URL CON TU URL DE GOOGLE SCRIPTS SI ES DIFERENTE
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzow393wQhfOrt85djreYPjxG21AfUERZnOVNIfVJZkjWd8s74zGflsw1uQhxzfe-WGQw/exec';

        function mostrarSeccion(s) {
            document.getElementById('sec-registro').classList.toggle('hidden', s !== 'registro');
            document.getElementById('sec-directorio').classList.toggle('hidden', s !== 'directorio');
            document.getElementById('btn-reg').className = s === 'registro' ? "flex-1 p-4 font-bold text-green-700 border-b-4 border-green-700" : "flex-1 p-4 font-bold text-gray-400 border-b-4 border-transparent";
            document.getElementById('btn-dir').className = s === 'directorio' ? "flex-1 p-4 font-bold text-green-700 border-b-4 border-green-700" : "flex-1 p-4 font-bold text-gray-400 border-b-4 border-transparent";
            if(s === 'directorio') cargarDatos();
        }

        const form = document.getElementById('mainForm');
        form.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "Sincronizando...";

            const data = {
                action: id ? 'editRegistro' : 'addRegistro',
                id: id,
                finca: document.getElementById('finca').value,
                responsable: document.getElementById('responsable').value,
                telefono: document.getElementById('telefono').value,
                vereda: document.getElementById('vereda').value, 
                aporto: document.getElementById('aporto').value,
                cantidad: document.getElementById('cantidad').value
            };

            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
            .then(() => {
                alert("‚úÖ Guardado correctamente.");
                resetForm();
                btn.disabled = false; btn.innerText = "GUARDAR REGISTRO üçå";
                if(id) mostrarSeccion('directorio');
            })
            .catch(err => {
                alert("‚ö†Ô∏è Error de red. Los datos se guardar√°n cuando haya mejor se√±al.");
                btn.disabled = false; btn.innerText = "GUARDAR REGISTRO üçå";
            });
        });

        function cargarDatos() {
            const lista = document.getElementById('lista');
            lista.innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-white text-4xl"></i><p class="text-white mt-2">Buscando datos...</p></div>';
            
            fetch(scriptURL + '?getRegistros=true')
            .then(res => res.json())
            .then(datos => {
                lista.innerHTML = "";
                if(!datos || datos.length === 0) {
                    lista.innerHTML = '<p class="text-center text-white bg-black/20 p-10 rounded-xl">No hay registros.</p>';
                    return;
                }
                datos.reverse().forEach(item => {
                    const card = document.createElement('div');
                    card.className = "glass-effect p-4 rounded-2xl shadow-lg border-l-8 " + (item.aporto === 'S√≠' ? 'border-green-600' : 'border-amber-500');
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900 leading-tight">${item.finca}</h3>
                                <p class="text-[10px] text-green-700 font-bold uppercase"><i class="fas fa-map-marker-alt"></i> ${item.vereda}</p>
                                <p class="text-xs text-gray-600 mt-1"><b>Due√±o:</b> ${item.responsable}</p>
                                <p class="text-xs text-blue-600 font-bold italic underline">Tel: ${item.telefono}</p>
                            </div>
                            <div class="text-center bg-green-100 p-2 rounded-xl min-w-[60px] border border-green-200">
                                <span class="text-2xl font-black text-green-800">${item.cantidad}</span>
                                <p class="text-[8px] font-bold text-green-700 uppercase">Racimos</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3 pt-2 border-t border-gray-100">
                            <button onclick='iniciarEdicion(${JSON.stringify(item)})' class="flex-1 bg-blue-50 text-blue-700 py-2 rounded-lg text-[10px] font-bold uppercase"><i class="fas fa-edit"></i> Editar</button>
                            <button onclick="eliminarRegistro(${item.id})" class="flex-1 bg-red-50 text-red-600 py-2 rounded-lg text-[10px] font-bold uppercase"><i class="fas fa-trash"></i> Borrar</button>
                        </div>`;
                    lista.appendChild(card);
                });
            })
            .catch(err => {
                lista.innerHTML = '<div class="text-center p-10 bg-red-100/80 rounded-xl"><p class="text-red-700 font-bold">No se pudo cargar el directorio.</p><p class="text-[10px]">Verifica que el script de Google est√© publicado como "Cualquier persona".</p></div>';
            });
        }

        function iniciarEdicion(item) {
            mostrarSeccion('registro');
            document.getElementById('form-title').innerText = "Editando Registro";
            document.getElementById('edit-id').value = item.id;
            document.getElementById('finca').value = item.finca;
            document.getElementById('responsable').value = item.responsable;
            document.getElementById('telefono').value = item.telefono;
            document.getElementById('vereda').value = item.vereda;
            document.getElementById('aporto').value = item.aporto;
            document.getElementById('cantidad').value = item.cantidad;
            document.getElementById('btn-save').innerText = "ACTUALIZAR DATOS";
            document.getElementById('btn-cancel').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function resetForm() {
            form.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('form-title').innerText = "Nuevo Aporte de Pl√°tano";
            document.getElementById('btn-save').innerText = "GUARDAR REGISTRO üçå";
            document.getElementById('btn-cancel').classList.add('hidden');
        }

        function eliminarRegistro(id) {
            if(!confirm("¬øBorrar definitivamente?")) return;
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'deleteRegistro', id: id}) })
            .then(() => { alert("Eliminado."); cargarDatos(); });
        }
    </script>
</body>
</html>
